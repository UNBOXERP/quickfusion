document.write('<div id="messages"></div>'),document.write('<div id="waitingPopUp"></div>'),document.write('<div id="kanban_orders" class="tabs"></div>');var e={};e[order_late_status_0]="ORDER_LATE_STATUS_0",e[order_late_status_1]="ORDER_LATE_STATUS_1",e[order_late_status_2]="ORDER_LATE_STATUS_2",e[order_late_status_3]="ORDER_LATE_STATUS_3";var a=null,u=null,t=compareVersions(DOL_VERSION,"5.0.7"),o=compareVersions(DOL_VERSION,"6.0.0"),n=compareVersions(DOL_VERSION,"6.0.6"),r=compareVersions(DOL_VERSION,"7.0.0"),l=compareVersions(DOL_VERSION,"8.0.0");function _(e,t,o,n){null==n&&(n="");var i=document.URL.split("?")[0];i+="?"+$("#listactionsfilter").serialize(),i+="&id="+t+"&newStatusID="+o+"&action=cardDrop&idwarehouse="+n,i+="&token="+token,$("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").show();var a="";return $.ajax({url:i,type:"GET",dataType:"html",async:!1,success:function(t,e){try{var o=JSON.parse(t);token=o.token,$("#input_token").val(token),"OK"===o.status?(""!=o.message&&$.jnotify(o.message),a=void 0!==o.data.newRef?"OK||"+o.data.newRef:"OK",$(".badge").each(function(e){void 0!==o.data.kanbanHeaderCounts[this.id]&&(this.textContent=o.data.kanbanHeaderCounts[this.id])}),$(".total_amount").each(function(e){var t=this.id.split("-")[1];void 0!==o.data.columnsAmountTotal[t]&&(this.textContent=o.data.columnsAmountTotal[t])})):($.jnotify(o.message,"warning",5e3),$("#kanban_orders").find(".e-targetclone").remove(),$("body").css("cursor","default"),a="KO")}catch(e){$.jnotify(e,"error",5e3),console.log(t),a="KO"}},error:function(e,t,o){alert(o),a="KO"},complete:function(e,t){$("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").hide()}}),a}$(function(){var d=0;a=ej.DataManager(kanbanData),u=$("#kanban_orders").ejKanban({enableTotalCount:enableNativeTotalCount,dataSource:a,locale:sfLocale,enableRTL:!1,columns:columns,keyField:"kanban_status",fields:{content:"ref_tiers",primaryKey:"rowid",priority:"priority",tag:orders_tag,title:"",color:"late_status",imageUrl:"undefined"!=typeof fieldImageUrl&&""!=fieldImageUrl?fieldImageUrl:null,collapsibleCards:{field:"",key:""}},cardSettings:{template:"",colorMapping:e,externalDropTarget:""},contextMenuSettings:{enable:!0,menuItems:[],customMenuItems:[{text:msgPrintKanbanView,target:ej.Kanban.Target.Header,template:""}]},cardDrag:function(e){if(void 0!==$(".e-targetclone").css("top")){var t=$(window).scrollTop();isElementVisibleOnView($(".e-targetclone"))?$(".e-targetclone").css({position:"relative",top:0}):$(".e-targetclone").css({position:"absolute",top:t})}},cardDragStop:function(e){d=0;var t=$(e.draggedElement).parent().data("ej-mappingkey"),o=$(e.dropTarget).parent().data("ej-mappingkey"),n=columnIDs[o];if(void 0===o||void 0===t||o==t||"ORDER_VALIDATED"!=o&&"ORDER_DRAFT"==t||"ORDER_VALIDATED"==o&&e.data[0][0].nbre_lignes<=0)return e.cancel=!0,$("#kanban_orders").find(".e-targetclone").remove(),$("body").css("cursor","default"),void("ORDER_VALIDATED"==o&&e.data[0][0].nbre_lignes<=0?$.jnotify(ActionNotAllowed_EmptyOrder,"warning"):"ORDER_VALIDATED"!=o&&"ORDER_DRAFT"==t?$.jnotify(ActionNotAllowed_YouMustValidateFirst,"warning"):$.jnotify(ActionNotAllowed,"warning"));if("ORDER_VALIDATED"==o&&"ORDER_DRAFT"==t&&stock_enabled&&STOCK_CALCULATE_ON_VALIDATE_ORDER&&e.data[0][0].qualified_for_stock_change)return warehouseListEmpty?$.jnotify(ValidationNotAllowed_NoWarehouse,"error"):(d=e.data[0][0].rowid,$("#warehouse_choice_dialog").ejDialog("open")),e.cancel=!0,$("#kanban_orders").find(".e-targetclone").remove(),void $("body").css("cursor","default");var i=$(e.draggedElement).prop("id"),a=_(e,i,n,"");if("KO"!==a){if("ORDER_VALIDATED"==o&&"ORDER_DRAFT"==t){var r=kanbanData.find(function(e){return e.rowid===i}),l=a.split("||"),c="";if(1<l.length&&(c=l[1].trim()),""!==c){r.ref=c;var s='<div id="order-'+r.rowid+'">';r.ref_tiers='<a class="object-link" href="'+DOL_URL_ROOT+"/commande/card.php?id="+r.rowid+'" target="_blank">'+r.ref+"</a>"+s+r.societe_nom+"</div>",r.ref_date_commande=r.ref+" - "+r.date_commande,r.ref_date_livraison=r.ref+" - "+r.date_livraison}u.refresh()}window.setTimeout(function(){$("#"+i).css("border-color","magenta")},100)}else e.cancel=!0,$("#kanban_invoices").find(".e-targetclone").remove(),$("body").css("cursor","default");tooltipsActive=!1},cardDrop:function(e){},cardClick:function(e){if(!tooltipsActive){console.log(tooltipsActive);var t=a.dataSource.json.length,o=-1,n="";for(i=0;i<t;i++)o=a.dataSource.json[i].rowid,n=a.dataSource.json[i].tooltip_content,$("#order-"+o).ejTooltip({content:n}),$(".tooltip-ref-"+o).each(function(e){$(this).text(a.dataSource.json[i].ref)});tooltipsActive=!0}},contextClick:function(e){"ejMenuClick"!=e.type&&"contextClick"!=e.type||e.text!=msgPrintKanbanView||this.print()},queryCellInfo:function(e){var t=-1===o?"soc.php":"card.php";null!=e.data.fk_soc&&""!=e.data.fk_soc&&null!=e.data.societe_nom&&""!=e.data.societe_nom&&$(e.card).find("div.e-card_image").wrap('<a href="'+DOL_URL_ROOT+"/societe/"+t+"?socid="+e.data.fk_soc+'" title="'+e.data.societe_nom+'" target="_blank"></a>')}}).data("ejKanban");var l=$("#warehouse_choice_dialog").ejDialog({title:WarehouseChoice,enableModal:!0,enableResize:!1,locale:sfLocale,enableRTL:!1,showOnInit:!1}).data("ejDialog"),c=$("#warehouse_choice_list").ejListBox({itemsCount:5}).data("ejListBox");$("#btnOK").ejButton({type:"button",size:"mini",showRoundedCorner:!0,click:function(e){var t=0;if(0<c.getSelectedItems().length&&(t=c.getSelectedItems()[0].value),0<t){var o=_(null,d,"ORDER_VALIDATED",t);if("KO"!==o){var n=kanbanData.find(function(e){return e.rowid===d}),i=o.split("||"),a="";if(1<i.length&&(a=i[1].trim()),n.kanban_status="ORDER_VALIDATED",""!==a){n.ref=a;var r='<div id="order-'+n.rowid+'">';n.ref_tiers='<a class="object-link" href="'+DOL_URL_ROOT+"/commande/card.php?id="+n.rowid+'" target="_blank">'+n.ref+"</a>"+r+n.societe_nom+"</div>",n.ref_date_commande=n.ref+" - "+n.date_commande,n.ref_date_livraison=n.ref+" - "+n.date_livraison}u.refresh()}window.setTimeout(function(){$("#"+d).css("border-color","magenta")},100)}l.close()}}),$("#btnCancel").ejButton({type:ej.ButtonType.Button,size:"mini",showRoundedCorner:!0,click:function(e){l.close()}})}),window.onerror=function(e,t,o,n,i){return $("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").hide(),console.log(e),!1};