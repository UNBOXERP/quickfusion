document.write('<div id="messages"></div>'),document.write('<div id="waitingPopUp"></div>'),document.write('<div id="kanban_propals" class="tabs"></div>');var a=null,s=null,t=compareVersions(DOL_VERSION,"5.0.7"),o=compareVersions(DOL_VERSION,"6.0.0"),e=compareVersions(DOL_VERSION,"6.0.6"),n=compareVersions(DOL_VERSION,"7.0.0"),r=compareVersions(DOL_VERSION,"8.0.0");$(function(){a=ej.DataManager(kanbanData),s=$("#kanban_propals").ejKanban({enableTotalCount:enableNativeTotalCount,dataSource:a,locale:sfLocale,enableRTL:!1,columns:columns,keyField:"fk_statut",fields:{content:"ref_tiers",primaryKey:"rowid",priority:"priority",tag:propals_tag,title:"",color:"late_status",imageUrl:"undefined"!=typeof fieldImageUrl&&""!=fieldImageUrl?fieldImageUrl:null,collapsibleCards:{field:"",key:""}},cardSettings:{template:"",colorMapping:colorMapping,externalDropTarget:""},contextMenuSettings:{enable:!0,menuItems:[],customMenuItems:[{text:msgPrintKanbanView,target:ej.Kanban.Target.Header,template:""}]},cardDrag:function(t){if(void 0!==$(".e-targetclone").css("top")){var e=$(window).scrollTop();isElementVisibleOnView($(".e-targetclone"))?$(".e-targetclone").css({position:"relative",top:0}):$(".e-targetclone").css({position:"absolute",top:e})}},cardDragStop:function(r){var l=$(r.draggedElement).prop("id"),c=$(r.draggedElement).parent().data("ej-mappingkey"),p=$(r.dropTarget).parent().data("ej-mappingkey"),t=columnIDs[p],e=document.URL.split("?")[0];return void 0===p||void 0===c?(r.cancel=!0,$("#kanban_propals").find(".e-targetclone").remove(),void $("body").css("cursor","default")):p===c?(r.cancel=!0,$("#kanban_propals").find(".e-targetclone").remove(),void $("body").css("cursor","default")):(e+="?"+$("#listactionsfilter").serialize(),e+="&id="+l+"&newStatusID="+t+"&action=cardDrop",e+="&token="+token,$("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").show(),$.ajax({url:e,type:"GET",dataType:"html",async:!1,success:function(e,t){try{var o=JSON.parse(e);if(token=o.token,$("#input_token").val(token),"OK"!==o.status)return $.jnotify(o.message,"warning",5e3),$("#kanban_propals").find(".e-targetclone").remove(),$("body").css("cursor","default"),!(r.cancel=!0);if(void 0!==o.data.newRef){var n=o.data.newRef;if("VALIDATED"==p&&"DRAFT"==c){var i=kanbanData.find(function(t){return t.rowid===l});if(""!==n){i.ref=n;var a='<div id="propal-'+i.rowid+'">';i.ref_tiers='<a class="object-link" href="'+DOL_URL_ROOT+"/comm/propal/card.php?id="+i.rowid+'" target="_blank">'+i.ref+"</a>"+a+i.societe_nom+"</div>"}s.refresh()}}return $(".badge").each(function(t){void 0!==o.data.kanbanHeaderCounts[this.id]&&(this.textContent=o.data.kanbanHeaderCounts[this.id])}),$(".total_amount").each(function(t){var e=this.id.split("-")[1];void 0!==o.data.columnsAmountTotal[e]&&(this.textContent=o.data.columnsAmountTotal[e])}),window.setTimeout(function(){$("#"+l).css("border-color","magenta")},100),$.jnotify(o.message),!0}catch(t){$.jnotify(t,"error",5e3),console.log(e),r.cancel=!0}},error:function(t,e,o){alert(o)},complete:function(t,e){$("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").hide()}}),void(tooltipsActive=!1))},cardDrop:function(t){},cardClick:function(t){if(!tooltipsActive){var e=a.dataSource.json.length,o=-1,n="";for(i=0;i<e;i++)o=a.dataSource.json[i].rowid,n=a.dataSource.json[i].tooltip_content,$("#propal-"+o).ejTooltip({content:n}),$(".tooltip-ref-"+o).each(function(t){$(this).text(a.dataSource.json[i].ref)});tooltipsActive=!0}},contextClick:function(t){"ejMenuClick"!=t.type&&"contextClick"!=t.type||t.text!=msgPrintKanbanView||this.print()},queryCellInfo:function(t){var e=-1===o?"soc.php":"card.php";null!=t.data.fk_soc&&""!=t.data.fk_soc&&null!=t.data.societe_nom&&""!=t.data.societe_nom&&$(t.card).find("div.e-card_image").wrap('<a href="'+DOL_URL_ROOT+"/societe/"+e+"?socid="+t.data.fk_soc+'" title="'+t.data.societe_nom+'" target="_blank"></a>')}}).data("ejKanban")}),window.onerror=function(t,e,o,n,i){return $("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").hide(),console.log(t),!1};