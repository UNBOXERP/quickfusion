document.write('<div id="messages"></div>'),document.write('<div id="waitingPopUp"></div>'),document.write('<div id="kanban_projets" class="tabs"></div>');var a=null,e=null,t=compareVersions(DOL_VERSION,"5.0.7"),n=compareVersions(DOL_VERSION,"6.0.0"),o=compareVersions(DOL_VERSION,"6.0.6"),r=compareVersions(DOL_VERSION,"7.0.0"),c=compareVersions(DOL_VERSION,"8.0.0");$(function(){a=ej.DataManager(kanbanData),e=$("#kanban_projets").ejKanban({enableTotalCount:enableNativeTotalCount,dataSource:a,locale:sfLocale,enableRTL:!1,columns:columns,keyField:"opp_status_code",fields:{content:"title",primaryKey:"rowid",priority:"priority",tag:projets_tag,title:"ref",color:"fk_statut",imageUrl:"undefined"!=typeof fieldImageUrl&&""!=fieldImageUrl?fieldImageUrl:null,collapsibleCards:{field:"",key:""}},cardSettings:{template:"",colorMapping:colorMapping},contextMenuSettings:{enable:!0,menuItems:[],customMenuItems:[{text:msgPrintKanbanView,target:ej.Kanban.Target.Header,template:""}]},externalDropTarget:"",create:function(e){for(var t=0;t<columns.length;t++)1!=columns[t].active&&$("#"+columns[t].key).parent().css("color","grey")},cardDrag:function(e){if(void 0!==$(".e-targetclone").css("top")){var t=$(window).scrollTop();isElementVisibleOnView($(".e-targetclone"))?$(".e-targetclone").css({position:"relative",top:0}):$(".e-targetclone").css({position:"absolute",top:t})}},cardDragStop:function(c){if(2!=c.data[0][0].fk_statut){var l=$(c.draggedElement).prop("id"),s=$(c.draggedElement).parent().data("ej-mappingkey"),p=$(c.dropTarget).parent().data("ej-mappingkey"),d=columnIDs[s],u=columnIDs[p],e=document.URL.split("?")[0];for($i=0;$i<columns.length;$i++)if(columns[$i].key==p&&(0===parseInt(columns[$i].active)||"PROJECT_STATUS_UNKNOWN"==p))return c.cancel=!0,$("#kanban_projets").find(".e-targetclone").remove(),$("body").css("cursor","default"),void(0===parseInt(columns[$i].active)?$.jnotify(ActionNotAllowed_ProjectDestStatusDisabled,"warning"):$.jnotify(ActionNotAllowed_ProjectDestStatusUnknown,"warning"));if(void 0===p||void 0===s)return c.cancel=!0,$("#kanban_projets").find(".e-targetclone").remove(),void $("body").css("cursor","default");if(p===s)return c.cancel=!0,$("#kanban_projets").find(".e-targetclone").remove(),void $("body").css("cursor","default");e+="?"+$("#listactionsfilter").serialize(),(e+="&id="+l+"&newStatusID="+u+"&action=cardDrop").indexOf(token)<0&&(e+="&token="+token),e=e.replace("#",""),$("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").show(),$.ajax({url:e,type:"GET",dataType:"html",async:!1,success:function(t,e){try{var n=JSON.parse(t);if(token=n.token,$("#input_token").val(token),console.log(n),"OK"!==n.status)return $.jnotify(n.message,"warning",5e3),$("#kanban_projets").find(".e-targetclone").remove(),$("body").css("cursor","default"),!(c.cancel=!0);if($(".badge").each(function(e){void 0!==n.data.kanbanHeaderCounts[this.id]&&(this.textContent=n.data.kanbanHeaderCounts[this.id])}),$(".total_opp_amount").each(function(e){var t=this.id.split("-")[1];void 0!==n.data.columnsOppAmountTotal[t]&&(this.textContent=n.data.columnsOppAmountTotal[t])}),"opp_percent"===projets_tag){c.data[0][0].opp_percent=n.data.project.opp_percent;var o='<span id="'+n.data.project.rowid+'-opp_percent">.*</span>',a='<span id="'+n.data.project.rowid+'-opp_percent">'+n.data.project.opp_percent+"</span>";c.data[0][0].tooltip_content=c.data[0][0].tooltip_content.replace(new RegExp(o,"i"),a)}if(1===parseInt(confKanviewplusEnabled)){c.data[0][0].datee=n.data.project.datee,setTimeout(function(){for(var e=0;e<kanbanData.length;e++)$("#"+kanbanData[e].rowid+"-datee").text(kanbanData[e].datee);if("exceeded"===n.data.project.dateeStatus){$("#"+n.data.project.rowid).css("background-color",confGlobalKANVIEWPLUS_DATEEND_EXCEEDED_COLOR);for(e=0;e<kanbanData.length;e++)if(parseInt(kanbanData[e].rowid)===parseInt(n.data.project.rowid)){kanbanData[e].dateeStatus="exceeded";break}}},400);var i='<span id="'+n.data.project.rowid+'-datee">.+</span>',r='<span id="'+n.data.project.rowid+'-datee">'+n.data.project.datee+"</span>";c.data[0][0].tooltip_content=c.data[0][0].tooltip_content.replace(new RegExp(i,"i"),r)}return $("body").trigger("cardDropSuccessProject",[l,s,p,d,u]),window.setTimeout(function(){$("#"+l).css("border-color","magenta")},100),$.jnotify(n.message),!0}catch(e){$.jnotify(e,"error",5e3),console.log(t),c.cancel=!0}},error:function(e,t,n){c.cancel=!0,alert(n)},complete:function(e,t){$("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").hide()}}),tooltipsActive=!1}else{c.cancel=!0,$("#kanban_projets").find(".e-targetclone").remove(),$("body").css("cursor","default");var t=UpdateNotAllowed_ProjectClosed;t?$.jnotify(t,"error"):$.jnotify("Drop cancelled","error")}},cardDrop:function(e){},cardClick:function(e){if(!tooltipsActive){console.log(tooltipsActive);var t=a.dataSource.json.length,n=-1,o="";for(i=0;i<t;i++)n=a.dataSource.json[i].rowid,o=a.dataSource.json[i].tooltip_content,$("#projet-"+n).ejTooltip({content:o}),$(".tooltip-ref-"+n).each(function(e){$(this).text(a.dataSource.json[i].ref)});tooltipsActive=!0}},contextClick:function(e){"ejMenuClick"!=e.type&&"contextClick"!=e.type||e.text!=msgPrintKanbanView||this.print()},queryCellInfo:function(e){var t=-1===n?"soc.php":"card.php";null!=e.data.fk_soc&&""!=e.data.fk_soc&&null!=e.data.societe_nom&&""!=e.data.societe_nom&&$(e.card).find("div.e-card_image").wrap('<a href="'+DOL_URL_ROOT+"/societe/"+t+"?socid="+e.data.fk_soc+'" title="'+e.data.societe_nom+'" target="_blank"></a>')}}).data("ejKanban")}),window.onerror=function(e,t,n,o,a){return $("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").hide(),console.log(e),!1};